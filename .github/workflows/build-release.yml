name: ðŸ­ Fillico CI/CD

on:
  push:
    branches: [master]
    tags:
      - "v*"
  pull_request:
    branches: [master]
  release:
    types: [created]

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # TESTS
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  test:
    name: ðŸ§ª Tests
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run tests
        run: |
          python -m pytest tests/ -v --tb=short

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # BUILD WINDOWS
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  build-windows:
    name: ðŸªŸ Build Windows
    runs-on: windows-latest
    needs: test
    if: startsWith(github.ref, 'refs/tags/v')

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Build executable
        run: |
          python -m PyInstaller fillico.spec --clean

      - name: Create installer with NSIS
        shell: pwsh
        run: |
          $version = "${{ github.ref_name }}".TrimStart("v")
          @"
          !include "MUI2.nsh"

          Name "Fillico"
          OutFile "dist\Fillico-Setup.exe"
          InstallDir "`$LOCALAPPDATA\Fillico"
          RequestExecutionLevel user

          !insertmacro MUI_PAGE_WELCOME
          !insertmacro MUI_PAGE_DIRECTORY
          !insertmacro MUI_PAGE_INSTFILES
          !insertmacro MUI_PAGE_FINISH

          !insertmacro MUI_LANGUAGE "French"

          Section "Install"
            SetOutPath "`$INSTDIR"
            File "dist\Fillico.exe"

            CreateDirectory "`$SMPROGRAMS\Fillico"
            CreateShortcut "`$SMPROGRAMS\Fillico\Fillico.lnk" "`$INSTDIR\Fillico.exe"
            CreateShortcut "`$DESKTOP\Fillico.lnk" "`$INSTDIR\Fillico.exe"

            WriteUninstaller "`$INSTDIR\Uninstall.exe"

            WriteRegStr HKCU "Software\Microsoft\Windows\CurrentVersion\Uninstall\Fillico" "DisplayName" "Fillico"
            WriteRegStr HKCU "Software\Microsoft\Windows\CurrentVersion\Uninstall\Fillico" "UninstallString" "`$INSTDIR\Uninstall.exe"
            WriteRegStr HKCU "Software\Microsoft\Windows\CurrentVersion\Uninstall\Fillico" "DisplayVersion" "$version"
            WriteRegStr HKCU "Software\Microsoft\Windows\CurrentVersion\Uninstall\Fillico" "Publisher" "Fillico"
          SectionEnd

          Section "Uninstall"
            Delete "`$INSTDIR\Fillico.exe"
            Delete "`$INSTDIR\Uninstall.exe"
            RMDir /r "`$INSTDIR"

            Delete "`$SMPROGRAMS\Fillico\Fillico.lnk"
            RMDir "`$SMPROGRAMS\Fillico"
            Delete "`$DESKTOP\Fillico.lnk"

            DeleteRegKey HKCU "Software\Microsoft\Windows\CurrentVersion\Uninstall\Fillico"
          SectionEnd
          "@ | Out-File -FilePath installer.nsi -Encoding UTF8

          makensis installer.nsi

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: Fillico-Windows
          path: dist/Fillico-Setup.exe

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # BUILD LINUX
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  build-linux:
    name: ðŸ§ Build Linux
    runs-on: ubuntu-latest
    needs: test
    if: startsWith(github.ref, 'refs/tags/v')

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Build executable
        run: |
          python -m PyInstaller fillico.spec --clean

      - name: Create .deb package
        run: |
          VERSION=$(echo "${{ github.ref_name }}" | sed 's/^v//')
          mkdir -p fillico-deb/DEBIAN
          mkdir -p fillico-deb/usr/local/bin
          mkdir -p fillico-deb/usr/share/applications
          mkdir -p fillico-deb/usr/share/icons/hicolor/256x256/apps

          cp dist/Fillico fillico-deb/usr/local/bin/fillico
          chmod 755 fillico-deb/usr/local/bin/fillico

          cp assets/images/logo.png fillico-deb/usr/share/icons/hicolor/256x256/apps/fillico.png

          cat > fillico-deb/DEBIAN/control <<EOF
          Package: fillico
          Version: ${VERSION}
          Architecture: amd64
          Maintainer: Fillico
          Description: Application de filigranage multi-plateforme avec style Kawaii Pop
          Section: graphics
          Priority: optional
          EOF

          cat > fillico-deb/usr/share/applications/fillico.desktop <<EOF
          [Desktop Entry]
          Type=Application
          Name=Fillico
          Comment=Application de filigranage Kawaii Pop
          Exec=/usr/local/bin/fillico
          Icon=fillico
          Categories=Graphics;
          Terminal=false
          EOF

          dpkg-deb --build fillico-deb "dist/Fillico-${VERSION}-amd64.deb"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: Fillico-Linux
          path: dist/Fillico-*-amd64.deb

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # BUILD MACOS
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  build-macos:
    name: ðŸŽ Build macOS
    runs-on: macos-latest
    needs: test
    if: startsWith(github.ref, 'refs/tags/v')

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Build executable
        run: |
          python -m PyInstaller fillico.spec --clean

      - name: Create DMG installer
        run: |
          mkdir -p dmg-content
          cp -p dist/Fillico dmg-content/
          ln -s /Applications dmg-content/Applications

          hdiutil create -volname "Fillico" -srcfolder dmg-content -ov -format UDZO "dist/Fillico-macOS.dmg"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: Fillico-macOS
          path: dist/Fillico-macOS.dmg

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # RELEASE
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  release:
    name: ðŸš€ Create Release
    runs-on: ubuntu-latest
    needs: [build-windows, build-linux, build-macos]
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - name: Download Windows artifact
        uses: actions/download-artifact@v4
        with:
          name: Fillico-Windows
          path: artifacts/windows

      - name: Download Linux artifact
        uses: actions/download-artifact@v4
        with:
          name: Fillico-Linux
          path: artifacts/linux

      - name: Download macOS artifact
        uses: actions/download-artifact@v4
        with:
          name: Fillico-macOS
          path: artifacts/macos

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            artifacts/windows/Fillico-Setup.exe
            artifacts/linux/*.deb
            artifacts/macos/Fillico-macOS.dmg
          body: |
            # ðŸ­ Fillico ${{ github.ref_name }}

            Application de filigranage multi-plateforme avec style Kawaii Pop !

            ## ðŸ“¦ TÃ©lÃ©chargements

            - **Windows** : `Fillico-Setup.exe` - Installateur Windows
            - **Linux** : `Fillico-*-amd64.deb` - Paquet Debian/Ubuntu
            - **macOS** : `Fillico-macOS.dmg` - Image disque macOS

            ## âœ¨ FonctionnalitÃ©s

            - Support images (PNG, JPG, JPEG, BMP, GIF)
            - Support PDF
            - Interface kawaii avec mascotte animÃ©e
            - Mode Quick via clic droit
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
