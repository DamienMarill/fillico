name: üç≠ Fillico CI/CD

on:
  push:
    branches: [master]
    tags:
      - "v*"
  pull_request:
    branches: [master]
  release:
    types: [created]

jobs:
  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  # TESTS
  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  test:
    name: üß™ Tests
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.1-dev libgirepository1.0-dev gir1.2-webkit2-4.1

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run tests
        run: |
          python -m pytest tests/ -v --tb=short

  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  # BUILD WINDOWS
  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  build-windows:
    name: ü™ü Build Windows
    runs-on: windows-latest
    needs: test
    if: startsWith(github.ref, 'refs/tags/v')

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Build executable
        run: |
          python -m PyInstaller fillico.spec --clean

      - name: Install NSIS
        run: choco install nsis -y

      - name: Create installer with NSIS
        shell: pwsh
        run: |
          $version = "${{ github.ref_name }}".TrimStart("v")
          @"
          !include "MUI2.nsh"

          Name "Fillico"
          OutFile "dist\Fillico-Setup.exe"
          InstallDir "`$LOCALAPPDATA\Fillico"
          RequestExecutionLevel user

          !insertmacro MUI_PAGE_WELCOME
          !insertmacro MUI_PAGE_DIRECTORY
          !insertmacro MUI_PAGE_INSTFILES
          !insertmacro MUI_PAGE_FINISH

          !insertmacro MUI_LANGUAGE "French"

          ; Macro pour enregistrer le menu contextuel par extension
          !macro RegisterContextMenu EXT
            WriteRegStr HKCU "Software\Classes\SystemFileAssociations\`${EXT}\shell\Fillico" "" "Ajouter un filigrane"
            WriteRegStr HKCU "Software\Classes\SystemFileAssociations\`${EXT}\shell\Fillico" "Icon" "`$INSTDIR\Fillico.exe"
            WriteRegStr HKCU "Software\Classes\SystemFileAssociations\`${EXT}\shell\Fillico\command" "" '"`$INSTDIR\Fillico.exe" --quick "%1"'
          !macroend

          ; Macro pour supprimer le menu contextuel par extension
          !macro UnregisterContextMenu EXT
            DeleteRegKey HKCU "Software\Classes\SystemFileAssociations\`${EXT}\shell\Fillico"
          !macroend

          Section "Install"
            SetOutPath "`$INSTDIR"
            File "dist\Fillico.exe"
            File "fillico.ico"

            CreateDirectory "`$SMPROGRAMS\Fillico"
            CreateShortcut "`$SMPROGRAMS\Fillico\Fillico.lnk" "`$INSTDIR\Fillico.exe"
            CreateShortcut "`$DESKTOP\Fillico.lnk" "`$INSTDIR\Fillico.exe"

            WriteUninstaller "`$INSTDIR\Uninstall.exe"

            ; Infos de d√©sinstallation
            WriteRegStr HKCU "Software\Microsoft\Windows\CurrentVersion\Uninstall\Fillico" "DisplayName" "Fillico"
            WriteRegStr HKCU "Software\Microsoft\Windows\CurrentVersion\Uninstall\Fillico" "UninstallString" "`$INSTDIR\Uninstall.exe"
            WriteRegStr HKCU "Software\Microsoft\Windows\CurrentVersion\Uninstall\Fillico" "DisplayVersion" "$version"
            WriteRegStr HKCU "Software\Microsoft\Windows\CurrentVersion\Uninstall\Fillico" "Publisher" "Fillico"
            WriteRegStr HKCU "Software\Microsoft\Windows\CurrentVersion\Uninstall\Fillico" "DisplayIcon" "`$INSTDIR\fillico.ico"

            ; Menu contextuel (clic droit)
            !insertmacro RegisterContextMenu ".png"
            !insertmacro RegisterContextMenu ".jpg"
            !insertmacro RegisterContextMenu ".jpeg"
            !insertmacro RegisterContextMenu ".bmp"
            !insertmacro RegisterContextMenu ".gif"
            !insertmacro RegisterContextMenu ".pdf"
          SectionEnd

          Section "Uninstall"
            Delete "`$INSTDIR\Fillico.exe"
            Delete "`$INSTDIR\fillico.ico"
            Delete "`$INSTDIR\Uninstall.exe"
            RMDir /r "`$INSTDIR"

            Delete "`$SMPROGRAMS\Fillico\Fillico.lnk"
            RMDir "`$SMPROGRAMS\Fillico"
            Delete "`$DESKTOP\Fillico.lnk"

            ; Nettoyage menu contextuel
            !insertmacro UnregisterContextMenu ".png"
            !insertmacro UnregisterContextMenu ".jpg"
            !insertmacro UnregisterContextMenu ".jpeg"
            !insertmacro UnregisterContextMenu ".bmp"
            !insertmacro UnregisterContextMenu ".gif"
            !insertmacro UnregisterContextMenu ".pdf"

            DeleteRegKey HKCU "Software\Microsoft\Windows\CurrentVersion\Uninstall\Fillico"
          SectionEnd
          "@ | Out-File -FilePath installer.nsi -Encoding ASCII

          $env:PATH += ";C:\Program Files (x86)\NSIS"
          makensis installer.nsi

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: Fillico-Windows
          path: dist/Fillico-Setup.exe

  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  # BUILD LINUX
  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  build-linux:
    name: üêß Build Linux
    runs-on: ubuntu-latest
    needs: test
    if: startsWith(github.ref, 'refs/tags/v')

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.1-dev libgirepository1.0-dev gir1.2-webkit2-4.1

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Build executable
        run: |
          python -m PyInstaller fillico.spec --clean

      - name: Create .deb package
        run: |
          VERSION=$(echo "${{ github.ref_name }}" | sed 's/^v//')
          mkdir -p fillico-deb/DEBIAN
          mkdir -p fillico-deb/usr/local/bin
          mkdir -p fillico-deb/usr/share/applications
          mkdir -p fillico-deb/usr/share/icons/hicolor/256x256/apps

          cp dist/Fillico fillico-deb/usr/local/bin/fillico
          chmod 755 fillico-deb/usr/local/bin/fillico

          cp assets/images/logo.png fillico-deb/usr/share/icons/hicolor/256x256/apps/fillico.png

          cat > fillico-deb/DEBIAN/control <<EOF
          Package: fillico
          Version: ${VERSION}
          Architecture: amd64
          Maintainer: Fillico
          Description: Application de filigranage multi-plateforme avec style Kawaii Pop
          Section: graphics
          Priority: optional
          EOF

          cat > fillico-deb/usr/share/applications/fillico.desktop <<EOF
          [Desktop Entry]
          Type=Application
          Name=Fillico
          Comment=Application de filigranage Kawaii Pop
          Exec=/usr/local/bin/fillico
          Icon=fillico
          Categories=Graphics;
          Terminal=false
          MimeType=image/png;image/jpeg;image/bmp;image/gif;application/pdf;
          EOF

          # Script Nautilus pour le clic droit
          cat > fillico-deb/DEBIAN/postinst <<'POSTINST'
          #!/bin/bash
          SCRIPT_DIR="$HOME/.local/share/nautilus/scripts"
          mkdir -p "$SCRIPT_DIR"
          cat > "$SCRIPT_DIR/üç≠ Ajouter un filigrane" <<'SCRIPT'
          #!/bin/bash
          SUPPORTED_EXT="png jpg jpeg bmp gif pdf"
          for file in $NAUTILUS_SCRIPT_SELECTED_FILE_PATHS; do
              if [[ -f "$file" ]]; then
                  ext="${file##*.}"
                  ext="${ext,,}"
                  if echo "$SUPPORTED_EXT" | grep -qw "$ext"; then
                      /usr/local/bin/fillico --quick "$file"
                  fi
              fi
          done
          SCRIPT
          chmod +x "$SCRIPT_DIR/üç≠ Ajouter un filigrane"
          POSTINST
          chmod 755 fillico-deb/DEBIAN/postinst

          # Script de nettoyage √† la d√©sinstallation
          cat > fillico-deb/DEBIAN/postrm <<'POSTRM'
          #!/bin/bash
          rm -f "$HOME/.local/share/nautilus/scripts/üç≠ Ajouter un filigrane"
          POSTRM
          chmod 755 fillico-deb/DEBIAN/postrm

          dpkg-deb --build fillico-deb "dist/Fillico-${VERSION}-amd64.deb"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: Fillico-Linux
          path: dist/Fillico-*-amd64.deb

  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  # BUILD MACOS
  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  build-macos:
    name: üçé Build macOS
    runs-on: macos-latest
    needs: test
    if: startsWith(github.ref, 'refs/tags/v')

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Build executable
        run: |
          python -m PyInstaller fillico.spec --clean

      - name: Create DMG installer
        run: |
          mkdir -p dmg-content
          cp -p dist/Fillico dmg-content/
          ln -s /Applications dmg-content/Applications

          hdiutil create -volname "Fillico" -srcfolder dmg-content -ov -format UDZO "dist/Fillico-macOS.dmg"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: Fillico-macOS
          path: dist/Fillico-macOS.dmg

  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  # RELEASE
  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  release:
    name: üöÄ Create Release
    runs-on: ubuntu-latest
    needs: [build-windows, build-linux, build-macos]
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - name: Download Windows artifact
        uses: actions/download-artifact@v4
        with:
          name: Fillico-Windows
          path: artifacts/windows

      - name: Download Linux artifact
        uses: actions/download-artifact@v4
        with:
          name: Fillico-Linux
          path: artifacts/linux

      - name: Download macOS artifact
        uses: actions/download-artifact@v4
        with:
          name: Fillico-macOS
          path: artifacts/macos

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            artifacts/windows/Fillico-Setup.exe
            artifacts/linux/*.deb
            artifacts/macos/Fillico-macOS.dmg
          body: |
            # üç≠ Fillico ${{ github.ref_name }}

            Application de filigranage multi-plateforme avec style Kawaii Pop !

            ## üì¶ T√©l√©chargements

            - **Windows** : `Fillico-Setup.exe` - Installateur Windows
            - **Linux** : `Fillico-*-amd64.deb` - Paquet Debian/Ubuntu
            - **macOS** : `Fillico-macOS.dmg` - Image disque macOS

            ## ‚ú® Fonctionnalit√©s

            - Support images (PNG, JPG, JPEG, BMP, GIF)
            - Support PDF
            - Interface kawaii avec mascotte anim√©e
            - Mode Quick via clic droit
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
